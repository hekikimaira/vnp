<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VN Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent: #ffffff;
            --accent-dim: rgba(255,255,255,0.6);
            --accent-subtle: rgba(255,255,255,0.1);
            --text: #ffffff;
            --text-dim: rgba(255,255,255,0.5);
            --border: rgba(255,255,255,0.08);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans JP',sans-serif;background:var(--bg-primary);color:var(--text);min-height:100vh;overflow:hidden;font-weight:300}
        
        .top-menu{position:fixed;inset:0;background:var(--bg-primary);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
        .top-menu.hidden{display:none}
        .game-title{font-size:28px;font-weight:300;letter-spacing:0.3em;color:var(--text);margin-bottom:40px;text-transform:uppercase}
        .menu-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:14px 56px;font-size:13px;font-weight:400;letter-spacing:0.15em;cursor:pointer;min-width:240px;transition:all 0.3s ease;text-transform:uppercase}
        .menu-btn:hover{border-color:var(--accent);color:var(--text);background:var(--accent-subtle)}
        .menu-btn:disabled{opacity:0.3;cursor:not-allowed}
        .menu-btn.has-new{position:relative}
        .menu-btn.has-new::after{content:'';position:absolute;top:50%;right:20px;transform:translateY(-50%);width:6px;height:6px;background:var(--text);border-radius:50%}
        .load-label{background:var(--accent-subtle)}
        
        .game-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
        .game-canvas{position:relative;aspect-ratio:832/1216;height:100%;max-width:100%;container-type:inline-size;overflow:hidden}
        .game-bg{position:absolute;inset:0}
        .game-bg img{width:100%;height:100%;object-fit:cover}
        .flash-overlay{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:10}
        .flash-overlay.active{animation:flash 0.15s ease-out}
        @keyframes flash{0%{opacity:0.9}100%{opacity:0}}
        .game-canvas.shake{animation:shake 0.3s ease-in-out}
        @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
        
        .transition-overlay{position:absolute;inset:0;z-index:15;pointer-events:none;opacity:0}
        .transition-overlay.black{background:#000}
        .transition-overlay.white{background:#fff}
        
        .game-bg.trans-fade{animation:transFade 0.5s ease-out}
        @keyframes transFade{0%{opacity:0}100%{opacity:1}}
        .game-bg.trans-slideLeft{animation:transSlideLeft 0.4s ease-out}
        @keyframes transSlideLeft{0%{transform:translateX(100%)}100%{transform:translateX(0)}}
        .game-bg.trans-slideRight{animation:transSlideRight 0.4s ease-out}
        @keyframes transSlideRight{0%{transform:translateX(-100%)}100%{transform:translateX(0)}}
        .game-bg.trans-slideUp{animation:transSlideUp 0.4s ease-out}
        @keyframes transSlideUp{0%{transform:translateY(100%)}100%{transform:translateY(0)}}
        .game-bg.trans-slideDown{animation:transSlideDown 0.4s ease-out}
        @keyframes transSlideDown{0%{transform:translateY(-100%)}100%{transform:translateY(0)}}
        
        .text-display{position:absolute;bottom:5%;left:4%;right:4%;z-index:5;transition:opacity 0.3s}
        .text-display.hidden-text{opacity:0;pointer-events:none}
        .text-display.nvl-mode{top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);display:flex;flex-direction:column;justify-content:flex-start;padding:3% 4%;overflow-y:auto}
        .nvl-mode .char-name{margin-bottom:1%}
        .nvl-mode .dialogue{line-height:1.7}
        .char-name{font-weight:400;color:#fff;text-shadow:0 0 4px #000,0 0 4px #000,2px 2px 4px #000,-2px -2px 4px #000,2px -2px 4px #000,-2px 2px 4px #000;margin-bottom:2%;letter-spacing:0.05em}
        .dialogue{line-height:1.8;color:#fff;text-shadow:0 0 4px #000,0 0 4px #000,2px 2px 4px #000,-2px -2px 4px #000,2px -2px 4px #000,-2px 2px 4px #000;white-space:pre-wrap;font-weight:300}
        .char-name.size-s{font-size:3cqw}.char-name.size-m{font-size:4cqw}.char-name.size-l{font-size:5cqw}
        .dialogue.size-s{font-size:2.5cqw}.dialogue.size-m{font-size:3.2cqw}.dialogue.size-l{font-size:4cqw}
        
        .choice-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2cqw;z-index:20;pointer-events:none}
        .choice-overlay.hidden{display:none}
        .choice-btn{background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:3cqw 6cqw;font-size:3cqw;font-weight:300;letter-spacing:0.1em;cursor:pointer;min-width:60%;text-align:center;transition:all 0.3s;pointer-events:auto}
        .choice-btn:hover{background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.5)}
        
        .choice-timer-container{display:flex;flex-direction:column;align-items:center;margin-bottom:3cqw}
        .choice-timer-circle{position:relative;width:12cqw;height:12cqw}
        .choice-timer-circle svg{width:100%;height:100%;transform:rotate(-90deg)}
        .choice-timer-circle .timer-bg{fill:none;stroke:rgba(255,255,255,0.15);stroke-width:3}
        .choice-timer-circle .timer-progress{fill:none;stroke:#fff;stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 0.1s linear}
        .choice-timer-circle .timer-progress.urgent{stroke:#ff6b6b}
        .choice-timer-number{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4cqw;font-weight:300;color:#fff}
        .choice-timer-number.urgent{color:#ff6b6b}
        
        .global-timer{position:absolute;top:2cqw;right:2cqw;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.15);padding:1.5cqw 3cqw;font-size:3cqw;font-weight:300;color:#fff;letter-spacing:0.1em;z-index:25;font-variant-numeric:tabular-nums}
        .global-timer.hidden{display:none}
        .global-timer.urgent{color:#ff6b6b;border-color:rgba(255,107,107,0.3)}
        
        .control-panel{position:absolute;bottom:2cqw;right:2cqw;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:1.5cqw;z-index:30}
        .ctrl-btn{width:7cqw;height:7cqw;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);font-size:2.2cqw;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .ctrl-btn:hover{background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.3)}
        .ctrl-btn.active{background:rgba(255,255,255,0.15);color:#fff;border-color:rgba(255,255,255,0.4)}
        .ctrl-btn svg{width:3cqw;height:3cqw;stroke:currentColor;stroke-width:1.5;fill:none}
        .ctrl-menu{display:flex;flex-direction:column;gap:1.5cqw;max-height:0;overflow:hidden;transition:max-height 0.3s ease,opacity 0.3s ease;opacity:0}
        .ctrl-menu.open{max-height:50cqw;opacity:1}
        
        .status-bar{position:absolute;top:2cqw;left:2cqw;display:flex;gap:1cqw;z-index:25}
        .status-icon{padding:1cqw 2cqw;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);font-size:1.8cqw;color:rgba(255,255,255,0.7);font-weight:400;letter-spacing:0.1em}
        
        .side-menu{position:absolute;top:0;right:0;width:280px;max-width:80%;height:100%;background:rgba(10,10,15,0.95);backdrop-filter:blur(20px);z-index:40;padding:24px;display:flex;flex-direction:column;gap:6px;transform:translateX(100%);transition:transform 0.3s ease;overflow-y:auto;border-left:1px solid var(--border)}
        .side-menu.open{transform:translateX(0)}
        .side-menu-title{font-size:10px;color:var(--text-dim);margin-top:16px;padding-bottom:8px;border-bottom:1px solid var(--border);letter-spacing:0.2em;text-transform:uppercase}
        .side-menu-btn{background:transparent;border:none;color:var(--text-dim);padding:12px 0;font-size:13px;font-weight:400;cursor:pointer;text-align:left;transition:all 0.2s;letter-spacing:0.05em}
        .side-menu-btn:hover{color:var(--text)}
        .side-menu-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;padding:8px}
        .side-menu-close:hover{color:var(--text)}
        
        .setting-row{display:flex;align-items:center;gap:12px;padding:8px 0}
        .setting-label{font-size:11px;color:var(--text-dim);min-width:50px}
        .setting-slider{flex:1;-webkit-appearance:none;height:1px;background:var(--border);outline:none}
        .setting-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--text);border-radius:50%;cursor:pointer}
        .size-btns{display:flex;gap:8px}
        .size-btn{padding:6px 16px;background:transparent;border:1px solid var(--border);color:var(--text-dim);font-size:11px;cursor:pointer;transition:all 0.2s}
        .size-btn:hover,.size-btn.active{border-color:var(--text);color:var(--text)}
        
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:200;display:flex;align-items:center;justify-content:center}
        .modal-overlay.hidden{display:none}
        .modal{background:var(--bg-secondary);border:1px solid var(--border);padding:32px;max-width:90%;max-height:80vh;overflow-y:auto;min-width:320px}
        .modal-title{font-size:12px;font-weight:400;color:var(--text-dim);margin-bottom:24px;letter-spacing:0.2em;text-transform:uppercase}
        .modal-close{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:12px 24px;font-size:12px;cursor:pointer;margin-top:24px;width:100%;transition:all 0.2s;letter-spacing:0.1em}
        .modal-close:hover{border-color:var(--text);color:var(--text)}
        
        .save-slot{background:var(--bg-tertiary);border:1px solid var(--border);padding:16px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
        .save-slot:hover{border-color:rgba(255,255,255,0.3)}
        .save-slot.empty{opacity:0.4}
        .save-slot-title{font-size:12px;font-weight:400;letter-spacing:0.05em}
        .save-slot-info{font-size:10px;color:var(--text-dim);margin-top:6px}
        .save-slot-auto{border-left:2px solid rgba(255,255,255,0.3)}
        .save-slot-quick{border-left:2px solid rgba(255,255,255,0.5)}
        
        .gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .gallery-item{aspect-ratio:832/1216;background:var(--bg-tertiary);overflow:hidden;cursor:pointer;position:relative;border:1px solid var(--border)}
        .gallery-item img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s}
        .gallery-item:hover img{transform:scale(1.05)}
        .gallery-item.locked{filter:brightness(0.2)}
        .gallery-item.locked::after{content:'';position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
        .gallery-item.new::before{content:'';position:absolute;top:8px;right:8px;width:6px;height:6px;background:#fff;border-radius:50%;z-index:1}
        
        .backlog-list{max-height:60vh;overflow-y:auto;padding:16px;background:rgba(0,0,0,0.3);border-radius:4px}
        .backlog-item{padding:12px 0;border-bottom:1px solid var(--border)}
        .backlog-item:last-child{border-bottom:none}
        .backlog-name{font-size:13px;color:var(--text);font-weight:700;margin-bottom:4px}
        .backlog-text{font-size:13px;color:var(--text-dim);line-height:1.8;white-space:pre-wrap}
        
        .new-scenes-banner{position:absolute;bottom:18%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:2cqw 4cqw;font-size:2cqw;font-weight:300;letter-spacing:0.1em;z-index:50;cursor:pointer}
        .new-scenes-banner.hidden{display:none}
        
        .hidden{display:none!important}
        input[type="file"]{display:none}
        
        .chapter-item{display:flex;gap:12px;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .chapter-item:hover{background:var(--accent-subtle);border-color:var(--accent)}
        .chapter-thumb{width:50px;height:73px;background:#000;border-radius:4px;overflow:hidden;flex-shrink:0}
        .chapter-thumb img{width:100%;height:100%;object-fit:cover}
        .chapter-info{flex:1}
        .chapter-title{font-size:14px;color:var(--text);margin-bottom:4px}
        .chapter-num{font-size:11px;color:var(--text-dim)}
        
        .overlay-container{position:absolute;inset:0;z-index:999;pointer-events:none;overflow:hidden}
        .overlay-item{position:absolute;pointer-events:none;will-change:transform,opacity}
        .overlay-item img{max-width:none;max-height:none}
    </style>
</head>
<body>
<div class="top-menu" id="topMenu">
    <div class="game-title" id="gameTitle">Visual Novel</div>
    <button class="menu-btn" id="startBtn" disabled>Start</button>
    <button class="menu-btn" id="continueBtn" disabled>Continue</button>
    <button class="menu-btn hidden" id="chaptersBtn">Chapters</button>
    <button class="menu-btn hidden" id="newScenesBtn">New Scenes</button>
    <button class="menu-btn" id="galleryBtn" disabled>Gallery</button>
    <label class="menu-btn load-label">Load ZIP<input type="file" id="zipInput" accept=".zip"></label>
    <button class="menu-btn" id="settingsBtn">Settings</button>
</div>
<div class="game-container hidden" id="gameContainer">
    <div class="game-canvas" id="gameCanvas">
        <div class="game-bg" id="gameBg"></div>
        <div class="flash-overlay" id="flashOverlay"></div>
        <div class="transition-overlay" id="transitionOverlay"></div>
        <div class="text-display" id="textDisplay">
            <div class="char-name size-m" id="charName"></div>
            <div class="dialogue size-m" id="dialogue"></div>
        </div>
        <div class="choice-overlay hidden" id="choiceOverlay"></div>
        <div class="status-bar"><span class="status-icon hidden" id="autoIcon">AUTO</span><span class="status-icon hidden" id="skipIcon">SKIP</span></div>
        <div class="global-timer hidden" id="globalTimer">00:00</div>
        <div class="control-panel">
            <button class="ctrl-btn" id="ctrlToggleBtn" title="メニュー">
                <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <div class="ctrl-menu" id="ctrlMenu">
                <button class="ctrl-btn" id="hamburgerBtn" title="サイドメニュー">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
                <button class="ctrl-btn" id="hideTextBtn" title="テキスト非表示">
                    <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <button class="ctrl-btn" id="autoBtn" title="オート">
                    <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </button>
                <button class="ctrl-btn" id="skipBtn" title="スキップ">
                    <svg viewBox="0 0 24 24"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
                </button>
                <button class="ctrl-btn" id="qsaveBtn" title="クイックセーブ">
                    <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                </button>
                <button class="ctrl-btn" id="qloadBtn" title="クイックロード">
                    <svg viewBox="0 0 24 24"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                </button>
            </div>
        </div>
        <div class="new-scenes-banner hidden" id="newScenesBanner">NEW SCENES AVAILABLE</div>
        <div class="overlay-container" id="overlayContainer"></div>
    </div>
    <div class="side-menu" id="sideMenu">
        <button class="side-menu-close" id="closeSideMenu">×</button>
        <div class="side-menu-title">Menu</div>
        <button class="side-menu-btn" id="sideMenuSave">Save</button>
        <button class="side-menu-btn" id="sideMenuLoad">Load</button>
        <button class="side-menu-btn" id="sideMenuBacklog">Backlog</button>
        <button class="side-menu-btn" id="sideMenuGallery">Gallery</button>
        <button class="side-menu-btn" id="sideMenuTitle">Title</button>
        <div class="side-menu-title">Sound</div>
        <div class="setting-row"><span class="setting-label">BGM</span><input type="range" class="setting-slider" id="bgmVolume" min="0" max="100" value="70"></div>
        <div class="setting-row"><span class="setting-label">SE</span><input type="range" class="setting-slider" id="seVolume" min="0" max="100" value="100"></div>
        <div class="side-menu-title">Text</div>
        <div class="setting-row"><span class="setting-label">Speed</span><input type="range" class="setting-slider" id="textSpeed" min="0" max="100" value="70"></div>
        <div class="side-menu-title">Font Size</div>
        <div class="size-btns"><button class="size-btn" data-size="s">S</button><button class="size-btn active" data-size="m">M</button><button class="size-btn" data-size="l">L</button></div>
        <div class="side-menu-title">Auto Speed</div>
        <div class="setting-row"><span class="setting-label">Wait</span><input type="range" class="setting-slider" id="autoSpeed" min="500" max="5000" value="2000"></div>
    </div>
</div>
<div class="modal-overlay hidden" id="saveModal"><div class="modal"><div class="modal-title">Save</div><div id="saveSlots"></div><button class="modal-close" id="closeSaveModal">Close</button></div></div>
<div class="modal-overlay hidden" id="loadModal"><div class="modal"><div class="modal-title">Load</div><div id="loadSlots"></div><button class="modal-close" id="closeLoadModal">Close</button></div></div>
<div class="modal-overlay hidden" id="galleryModal"><div class="modal" style="max-width:480px"><div class="modal-title">Gallery</div><div class="gallery-grid" id="galleryGrid"></div><button class="modal-close" id="closeGalleryModal">Close</button></div></div>
<div class="modal-overlay hidden" id="backlogModal"><div class="modal" style="max-width:90%;width:500px;max-height:85vh"><div class="modal-title">Backlog</div><div class="backlog-list" id="backlogList"></div><button class="modal-close" id="closeBacklogModal">Close</button></div></div>
<div class="modal-overlay hidden" id="settingsModal"><div class="modal"><div class="modal-title">Settings</div><div class="setting-row"><span class="setting-label">BGM</span><input type="range" class="setting-slider" id="settingsBgmVolume" min="0" max="100" value="70"></div><div class="setting-row"><span class="setting-label">SE</span><input type="range" class="setting-slider" id="settingsSeVolume" min="0" max="100" value="100"></div><div class="setting-row"><span class="setting-label">Speed</span><input type="range" class="setting-slider" id="settingsTextSpeed" min="0" max="100" value="70"></div><div class="side-menu-title">Font Size</div><div class="size-btns" id="settingsSizeBtns"><button class="size-btn" data-size="s">S</button><button class="size-btn active" data-size="m">M</button><button class="size-btn" data-size="l">L</button></div><button class="modal-close" id="closeSettingsModal">Close</button></div></div>
<div class="modal-overlay hidden" id="chaptersModal"><div class="modal" style="max-width:400px"><div class="modal-title">Chapters</div><div id="chaptersList" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow-y:auto"></div><button class="modal-close" id="closeChaptersModal">Close</button></div></div>
<script>
let scenes=[],imageBlobs={},currentIndex=0,flags={},lastChoiceId=null,seenScenes=new Set(),newSceneUUIDs=new Set(),isGalleryMode=false,backlog=[],chapters=[];
let bgmVolume=0.7,seVolume=1.0,textSpeed=70,autoSpeed=2000,fontSize='m';
let isAutoMode=false,isSkipMode=false,isTextHidden=false,autoTimer=null,skipTimer=null,textAnimTimer=null,isTextAnimating=false;
const seAudios={};const bgmAudios={};let currentBgm=null;let loopingSe={};
let projectId=null;

// Counter system (persistent across playthroughs)
let counters = {};

// Global timer system
let globalTimers = {};
let globalTimerInterval = null;

// Timed choice system
let timedChoiceTimer = null;

const $=id=>document.getElementById(id);
const topMenu=$('topMenu'),gameContainer=$('gameContainer'),gameCanvas=$('gameCanvas'),gameBg=$('gameBg'),flashOverlay=$('flashOverlay'),textDisplay=$('textDisplay'),charName=$('charName'),dialogue=$('dialogue'),choiceOverlay=$('choiceOverlay'),sideMenu=$('sideMenu'),newScenesBanner=$('newScenesBanner'),autoIcon=$('autoIcon'),skipIcon=$('skipIcon'),globalTimerEl=$('globalTimer'),overlayContainer=$('overlayContainer');

// Overlay system
let activeOverlays = {}; // id -> {element, animations}

// ===== Counter System =====
function getCounterKey() { return projectId ? `vn-${projectId}-counters` : 'vn-counters'; }
function loadCounters() { try { const d = JSON.parse(localStorage.getItem(getCounterKey())); if (d) counters = d; } catch(e) { counters = {}; } }
function saveCounters() { localStorage.setItem(getCounterKey(), JSON.stringify(counters)); }
function setCounter(name, val) { counters[name] = val; saveCounters(); }
function addCounter(name, delta) { counters[name] = (counters[name] || 0) + delta; saveCounters(); }
function resetCounter(name) { counters[name] = 0; saveCounters(); }
function getCounter(name) { return counters[name] || 0; }

// ===== Global Timer =====
function formatTime(sec) { const m = Math.floor(sec / 60); const s = Math.floor(sec % 60); return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0'); }
function updateGlobalTimerDisplay() {
    let activeTimer = null;
    for (const id in globalTimers) { const t = globalTimers[id]; if (t && t.remaining > 0) { activeTimer = t; break; } }
    if (activeTimer && activeTimer.show !== false) {
        globalTimerEl.textContent = formatTime(Math.ceil(activeTimer.remaining));
        globalTimerEl.classList.remove('hidden');
        globalTimerEl.classList.toggle('urgent', activeTimer.remaining <= 10);
    } else { globalTimerEl.classList.add('hidden'); }
}
function startGlobalTimerTick() {
    if (globalTimerInterval) return;
    globalTimerInterval = setInterval(() => {
        for (const id in globalTimers) { const t = globalTimers[id]; if (t && t.mode === 'realtime' && t.remaining > 0) { t.remaining = Math.max(0, t.remaining - 0.1); } }
        updateGlobalTimerDisplay();
    }, 100);
}
function stopGlobalTimerTick() { if (globalTimerInterval) { clearInterval(globalTimerInterval); globalTimerInterval = null; } }
function startGlobalTimer(id, seconds, mode, show) { globalTimers[id] = { seconds, mode, remaining: seconds, show }; if (mode === 'realtime') startGlobalTimerTick(); updateGlobalTimerDisplay(); }
function endGlobalTimer(id) { if (globalTimers[id]) delete globalTimers[id]; if (Object.keys(globalTimers).length === 0) stopGlobalTimerTick(); updateGlobalTimerDisplay(); }
function decrementGlobalTimer(id, delta) { if (globalTimers[id]) { globalTimers[id].remaining = Math.max(0, globalTimers[id].remaining - delta); } updateGlobalTimerDisplay(); }

// ===== Timed Choice =====
function showTimedChoices(choices, seconds, showTimer, forceProgress, timeoutGoto) {
    choiceOverlay.innerHTML = '';
    if (showTimer) {
        const radius = 40, circumference = 2 * Math.PI * radius;
        const timerContainer = document.createElement('div');
        timerContainer.className = 'choice-timer-container';
        timerContainer.innerHTML = `<div class="choice-timer-circle"><svg viewBox="0 0 100 100"><circle class="timer-bg" cx="50" cy="50" r="${radius}"/><circle class="timer-progress" id="timerProgress" cx="50" cy="50" r="${radius}" stroke-dasharray="${circumference}" stroke-dashoffset="0"/></svg><div class="choice-timer-number" id="timerNumber">${seconds}</div></div>`;
        choiceOverlay.appendChild(timerContainer);
    }
    choices.forEach(c => { const b = document.createElement('button'); b.className = 'choice-btn'; b.textContent = c.text || c.id; b.onclick = () => selectTimedChoice(c); choiceOverlay.appendChild(b); });
    choiceOverlay.classList.remove('hidden');
    const startTime = Date.now(), circumference = 2 * Math.PI * 40;
    timedChoiceTimer = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000, remaining = Math.max(0, seconds - elapsed);
        if (showTimer) {
            const progress = $('timerProgress'), number = $('timerNumber');
            if (progress && number) {
                progress.style.strokeDashoffset = (elapsed / seconds) * circumference;
                number.textContent = Math.ceil(remaining);
                const isUrgent = remaining <= 3;
                progress.classList.toggle('urgent', isUrgent);
                number.classList.toggle('urgent', isUrgent);
            }
        }
        if (remaining <= 0) {
            clearInterval(timedChoiceTimer); timedChoiceTimer = null;
            if (forceProgress) {
                choiceOverlay.classList.add('hidden');
                if (timeoutGoto) { const idx = findSceneByLabel(timeoutGoto); if (idx >= 0) { currentIndex = idx; showScene(); return; } }
                currentIndex++; showScene();
            }
        }
    }, 50);
}
function selectTimedChoice(c) {
    if (c.timerDelta) { for (const id in globalTimers) { decrementGlobalTimer(id, -c.timerDelta); } }
    if (timedChoiceTimer) { clearInterval(timedChoiceTimer); timedChoiceTimer = null; }
    lastChoiceId = c.id; choiceOverlay.classList.add('hidden');
    if (c.goto) { const idx = findSceneByLabel(c.goto); if (idx >= 0) { currentIndex = idx; showScene(); return; } }
    currentIndex++; showScene();
}

function getStorageKey(key){return projectId?`vn-${projectId}-${key}`:`vn-${key}`}
function saveProgress(){localStorage.setItem(getStorageKey('progress'),JSON.stringify({seenScenes:[...seenScenes],bgmVolume,seVolume,textSpeed,autoSpeed,fontSize}))}
function loadProgress(){try{const d=JSON.parse(localStorage.getItem(getStorageKey('progress')));if(d){seenScenes=new Set(d.seenScenes||[]);bgmVolume=d.bgmVolume??0.7;seVolume=d.seVolume??1.0;textSpeed=d.textSpeed??70;autoSpeed=d.autoSpeed??2000;fontSize=d.fontSize||'m';updateSettingsUI()}}catch(e){}}
function saveSlot(n){const s=scenes[currentIndex];localStorage.setItem(getStorageKey(`slot-${n}`),JSON.stringify({currentIndex,flags:{...flags},lastChoiceId,seenScenes:[...seenScenes],backlog:backlog.slice(-50),globalTimers:{...globalTimers},timestamp:Date.now(),sceneName:s?.name||'',sceneText:(s?.text||'').slice(0,30)}));saveProgress()}
function loadSlot(n){try{const d=JSON.parse(localStorage.getItem(getStorageKey(`slot-${n}`)));if(d){currentIndex=d.currentIndex||0;flags=d.flags||{};lastChoiceId=d.lastChoiceId||null;seenScenes=new Set(d.seenScenes||[]);backlog=d.backlog||[];globalTimers=d.globalTimers||{};if(Object.keys(globalTimers).length>0){for(const id in globalTimers){if(globalTimers[id].mode==='realtime')startGlobalTimerTick()}}updateGlobalTimerDisplay();return true}}catch(e){}return false}
function getSlotInfo(n){try{const d=JSON.parse(localStorage.getItem(getStorageKey(`slot-${n}`)));if(d)return{exists:true,date:new Date(d.timestamp).toLocaleString('ja-JP'),sceneName:d.sceneName,sceneText:d.sceneText}}catch(e){}return{exists:false}}
function autoSave(){saveSlot(0)}
function quickSave(){saveSlot(-1);showToast('Quick Saved')}
function quickLoad(){if(loadSlot(-1)){showScene();showToast('Quick Loaded')}else{showToast('No save data')}}
function showToast(msg){const t=document.createElement('div');t.style.cssText='position:fixed;bottom:20%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:12px 24px;z-index:300;font-size:12px;letter-spacing:0.1em;';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),1500)}
function updateSettingsUI(){$('bgmVolume').value=bgmVolume*100;$('seVolume').value=seVolume*100;$('settingsBgmVolume').value=bgmVolume*100;$('settingsSeVolume').value=seVolume*100;$('textSpeed').value=textSpeed;$('settingsTextSpeed').value=textSpeed;$('autoSpeed').value=autoSpeed;if(currentBgm&&bgmAudios[currentBgm])bgmAudios[currentBgm].audio.volume=bgmVolume;document.querySelectorAll('.size-btn').forEach(b=>b.classList.toggle('active',b.dataset.size===fontSize));charName.className=`char-name size-${fontSize}`;dialogue.className=`dialogue size-${fontSize}`}
['bgmVolume','settingsBgmVolume'].forEach(id=>{$(id).oninput=e=>{bgmVolume=e.target.value/100;if(currentBgm&&bgmAudios[currentBgm])bgmAudios[currentBgm].audio.volume=bgmVolume;updateSettingsUI();saveProgress()}});
['seVolume','settingsSeVolume'].forEach(id=>{$(id).oninput=e=>{seVolume=e.target.value/100;updateSettingsUI();saveProgress()}});
['textSpeed','settingsTextSpeed'].forEach(id=>{$(id).oninput=e=>{textSpeed=+e.target.value;updateSettingsUI();saveProgress()}});
$('autoSpeed').oninput=e=>{autoSpeed=+e.target.value;saveProgress()};
document.querySelectorAll('.size-btn').forEach(b=>{b.onclick=()=>{fontSize=b.dataset.size;updateSettingsUI();saveProgress()}});

$('zipInput').onchange=async e=>{const file=e.target.files[0];if(!file)return;try{const zip=await JSZip.loadAsync(file);scenes=[];imageBlobs={};chapters=[];Object.keys(seAudios).forEach(k=>delete seAudios[k]);Object.keys(bgmAudios).forEach(k=>delete bgmAudios[k]);currentBgm=null;const imgFolder=zip.folder('images');if(imgFolder){const files=[];imgFolder.forEach((p,f)=>{if(!f.dir)files.push({p,f})});for(const{p,f}of files){const blob=await f.async('blob');const filename=p.split('/').pop();imageBlobs[filename]=URL.createObjectURL(blob)}}const audioFolder=zip.folder('audio');if(audioFolder){const af=[];audioFolder.forEach((p,f)=>{if(!f.dir)af.push({p,f})});for(const{p,f}of af){const blob=await f.async('blob');const url=URL.createObjectURL(blob);const filename=p.split('/').pop();const name=filename.split('.')[0].toLowerCase();console.log('Audio loaded:',p,'->',name);if(name.startsWith('se')){const audio=new Audio(url);seAudios[name]={audio,url}}else if(name.startsWith('bgm')){const audio=new Audio(url);audio.loop=true;bgmAudios[name]={audio,url}}}}const dataFile=zip.file('data.json');if(dataFile){const json=await dataFile.async('string');const data=JSON.parse(json);projectId=generateProjectId(data.scenes);scenes=(data.scenes||[]).map((s,i)=>({...s,uuid:s.uuid||`scene-${i}-${s.id}`,bgUrl:s.bg&&imageBlobs[s.bg]?imageBlobs[s.bg]:null}));chapters=data.chapters||[];if(data.title)$('gameTitle').textContent=data.title}loadProgress();loadCounters();checkNewScenes();$('startBtn').disabled=false;$('galleryBtn').disabled=false;$('continueBtn').disabled=!getSlotInfo(0).exists;$('chaptersBtn').classList.toggle('hidden',chapters.length===0);updateNewScenesButton()}catch(err){console.error(err);alert('Load error: '+err.message)}};
function generateProjectId(s){const str=JSON.stringify(s.map(x=>x.id));let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0}return Math.abs(h).toString(36)}
function checkNewScenes(){newSceneUUIDs.clear();scenes.forEach(s=>{if(!seenScenes.has(s.uuid))newSceneUUIDs.add(s.uuid)})}
function updateNewScenesButton(){const b=$('newScenesBtn');if(newSceneUUIDs.size>0){b.classList.remove('hidden');b.classList.add('has-new');b.textContent=`New Scenes (${newSceneUUIDs.size})`;b.disabled=false}else{b.classList.add('hidden')}}
function startGame(from=0){currentIndex=from;flags={};lastChoiceId=null;backlog=[];globalTimers={};stopGlobalTimerTick();updateGlobalTimerDisplay();overlayContainer.innerHTML='';activeOverlays={};topMenu.classList.add('hidden');gameContainer.classList.remove('hidden');isGalleryMode=false;stopAuto();stopSkip();showScene()}
function continueGame(){if(loadSlot(0)){topMenu.classList.add('hidden');gameContainer.classList.remove('hidden');isGalleryMode=false;stopAuto();stopSkip();showScene()}}
function goToNewScenes(){const idx=scenes.findIndex(s=>newSceneUUIDs.has(s.uuid));if(idx>=0){startGame(idx);newScenesBanner.classList.remove('hidden')}}
async function applyTransition(type) {
    const overlay = $('transitionOverlay'); const bg = gameBg;
    if (!type || type === 'none') return;
    bg.classList.remove('trans-fade', 'trans-slideLeft', 'trans-slideRight', 'trans-slideUp', 'trans-slideDown');
    overlay.classList.remove('black', 'white'); overlay.style.opacity = '0';
    if (type === 'fadeBlack' || type === 'fadeWhite') {
        overlay.classList.add(type === 'fadeBlack' ? 'black' : 'white'); overlay.style.opacity = '1';
        await new Promise(r => setTimeout(r, 250)); overlay.style.transition = 'opacity 0.25s'; overlay.style.opacity = '0';
        await new Promise(r => setTimeout(r, 250)); overlay.style.transition = '';
    } else if (type === 'fade') { bg.classList.add('trans-fade'); await new Promise(r => setTimeout(r, 500));
    } else if (type.startsWith('slide')) { bg.classList.add('trans-' + type); await new Promise(r => setTimeout(r, 400)); }
}

async function showScene(){
    if (timedChoiceTimer) { clearInterval(timedChoiceTimer); timedChoiceTimer = null; }
    choiceOverlay.classList.add('hidden'); clearTimeout(textAnimTimer); isTextAnimating=false;
    // Clear overlays on scene change
    overlayContainer.innerHTML = ''; activeOverlays = {};
    if(currentIndex<0||currentIndex>=scenes.length){returnToTitle();return}
    const scene=scenes[currentIndex];
    seenScenes.add(scene.uuid); newSceneUUIDs.delete(scene.uuid);
    if(newSceneUUIDs.size===0)newScenesBanner.classList.add('hidden');
    const result=await runCmdSequence(scene.cmd);
    if(result==='SKIP'){currentIndex++;showScene();return}
    if(result&&result.goto){const idx=findSceneByLabel(result.goto);if(idx>=0){currentIndex=idx;showScene();return}}
    if (scene.timerStart && scene.timerStartId) { startGlobalTimer(scene.timerStartId, scene.timerStartSeconds || 60, scene.timerMode || 'realtime', scene.timerShow !== false); }
    if (scene.timerEnd && scene.timerEndId) { endGlobalTimer(scene.timerEndId); }
    for (const id in globalTimers) { if (globalTimers[id].mode === 'selection') { decrementGlobalTimer(id, 1); } }
    gameBg.innerHTML=scene.bgUrl?`<img src="${scene.bgUrl}">`:'';
    await applyTransition(scene.transition);
    charName.textContent=scene.name||''; charName.style.display=scene.name?'block':'none';
    animateText(scene.text||'');
    if(scene.textMode==='nvl'){textDisplay.classList.add('nvl-mode')}else{textDisplay.classList.remove('nvl-mode')}
    if(scene.name||scene.text){backlog.push({index:currentIndex,name:scene.name||'',text:scene.text||''});if(backlog.length>100)backlog.shift()}
    if(scene.isChoice&&scene.choices&&scene.choices.length>0){
        const showFn = () => { if (scene.isTimed && scene.timedSeconds > 0) { showTimedChoices(scene.choices, scene.timedSeconds, scene.showTimer !== false, scene.forceProgress !== false, scene.timeoutGoto); } else { showChoices(scene.choices); } };
        if(isSkipMode||textSpeed===100){showFn()}else{setTimeout(showFn,getTextAnimDuration(scene.text||''))}
        stopAuto();stopSkip();
    }
    if(!isGalleryMode)autoSave();
    if(isAutoMode&&!scene.isChoice){autoTimer=setTimeout(()=>{if(isAutoMode)nextScene()},getTextAnimDuration(scene.text||'')+autoSpeed)}
    if(isSkipMode&&!scene.isChoice&&seenScenes.has(scene.uuid)){skipTimer=setTimeout(()=>{if(isSkipMode)nextScene()},50)}else if(isSkipMode&&!seenScenes.has(scene.uuid)){stopSkip()}
}

function getTextAnimDuration(t){if(textSpeed===100)return 0;return t.length*((100-textSpeed)*0.5+10)}
function animateText(t){if(textSpeed===100){dialogue.textContent=t;return}dialogue.textContent='';isTextAnimating=true;let i=0;const ct=(100-textSpeed)*0.5+10;function add(){if(i<t.length){dialogue.textContent+=t[i];i++;textAnimTimer=setTimeout(add,ct)}else{isTextAnimating=false}}add()}
function finishTextAnim(){if(isTextAnimating){clearTimeout(textAnimTimer);dialogue.textContent=scenes[currentIndex]?.text||'';isTextAnimating=false}}
function showChoices(choices){choiceOverlay.innerHTML='';choices.forEach(c=>{const b=document.createElement('button');b.className='choice-btn';b.textContent=c.text||c.id;b.onclick=()=>selectChoice(c);choiceOverlay.appendChild(b)});choiceOverlay.classList.remove('hidden')}
function selectChoice(c){ if (c.timerDelta) { for (const id in globalTimers) { decrementGlobalTimer(id, -c.timerDelta); } } lastChoiceId=c.id;choiceOverlay.classList.add('hidden');if(c.goto){const idx=findSceneByLabel(c.goto);if(idx>=0){currentIndex=idx;showScene();return}}currentIndex++;showScene()}
function findSceneByLabel(l){return scenes.findIndex(s=>s.label===l||String(s.id)===l)}
function nextScene(){if(!choiceOverlay.classList.contains('hidden'))return;if(isTextAnimating){finishTextAnim();return}if(currentIndex<scenes.length-1){currentIndex++;showScene()}else{returnToTitle()}}
function prevScene(){if(!choiceOverlay.classList.contains('hidden'))return;if(currentIndex>0){currentIndex--;showScene()}}
function returnToTitle(){gameContainer.classList.add('hidden');sideMenu.classList.remove('open');topMenu.classList.remove('hidden');stopBGM();stopAllSE();stopAuto();stopSkip();stopGlobalTimerTick();globalTimers={};updateGlobalTimerDisplay();overlayContainer.innerHTML='';activeOverlays={};checkNewScenes();updateNewScenesButton()}
function toggleAuto(){isAutoMode=!isAutoMode;$('autoBtn').classList.toggle('active',isAutoMode);autoIcon.classList.toggle('hidden',!isAutoMode);if(isAutoMode){stopSkip();const s=scenes[currentIndex];if(!s?.isChoice&&!isTextAnimating){autoTimer=setTimeout(()=>{if(isAutoMode)nextScene()},autoSpeed)}}else{clearTimeout(autoTimer)}}
function stopAuto(){isAutoMode=false;$('autoBtn').classList.remove('active');autoIcon.classList.add('hidden');clearTimeout(autoTimer)}
function toggleSkip(){isSkipMode=!isSkipMode;$('skipBtn').classList.toggle('active',isSkipMode);skipIcon.classList.toggle('hidden',!isSkipMode);if(isSkipMode){stopAuto();finishTextAnim();const s=scenes[currentIndex];if(!s?.isChoice&&seenScenes.has(s?.uuid)){skipTimer=setTimeout(()=>{if(isSkipMode)nextScene()},50)}}else{clearTimeout(skipTimer)}}
function stopSkip(){isSkipMode=false;$('skipBtn').classList.remove('active');skipIcon.classList.add('hidden');clearTimeout(skipTimer)}
function toggleTextHidden(){isTextHidden=!isTextHidden;textDisplay.classList.toggle('hidden-text',isTextHidden);$('hideTextBtn').classList.toggle('active',isTextHidden)}
function doFlash(){flashOverlay.classList.remove('active');void flashOverlay.offsetWidth;flashOverlay.classList.add('active')}
function doShake(){gameCanvas.classList.remove('shake');void gameCanvas.offsetWidth;gameCanvas.classList.add('shake')}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
async function playSE(name,count){
    console.log('playSE:',name,count,'seAudios:',Object.keys(seAudios));
    const se=seAudios[name];
    if(!se){console.log('SE not found:',name);return}
    se.audio.volume=seVolume;
    if(count===0){const loop=()=>{se.audio.currentTime=0;se.audio.play()};se.audio.onended=loop;loop();loopingSe[name]=true;return}
    // 1回だけ再生開始（awaitしない）
    se.audio.currentTime=0;
    se.audio.play().catch(e=>console.log('SE play error:',e));
}
function stopSE(name){const se=seAudios[name];if(!se)return;se.audio.pause();se.audio.currentTime=0;se.audio.onended=null;delete loopingSe[name]}
function stopAllSE(){Object.keys(seAudios).forEach(name=>stopSE(name))}
function playBGM(name){
    console.log('playBGM:',name,'bgmAudios:',Object.keys(bgmAudios));
    if(currentBgm&&bgmAudios[currentBgm]){bgmAudios[currentBgm].audio.pause();bgmAudios[currentBgm].audio.currentTime=0}
    const bgm=bgmAudios[name];
    if(!bgm){console.log('BGM not found:',name);return}
    bgm.audio.loop=true;bgm.audio.volume=bgmVolume;
    bgm.audio.play().catch(e=>console.log('BGM play error:',e));
    currentBgm=name;
}
function stopBGM(){if(currentBgm&&bgmAudios[currentBgm]){bgmAudios[currentBgm].audio.pause();bgmAudios[currentBgm].audio.currentTime=0}currentBgm=null}

// ===== Overlay System =====
function parseEasing(e) {
    const map = { linear:'linear', easein:'ease-in', easeout:'ease-out', easeinout:'ease-in-out', bounce:'cubic-bezier(0.68,-0.55,0.265,1.55)' };
    return map[(e||'easeout').toLowerCase()] || 'ease-out';
}
function parseSpeed(s) {
    if (!s) return 500;
    if (typeof s === 'number') return s;
    const str = String(s).toLowerCase();
    if (str === 'slow') return 1000;
    if (str === 'fast') return 200;
    if (str === 'normal') return 500;
    return parseInt(str) || 500;
}
async function runOverlay(cmd) {
    // OVERLAY:CLEAR or OVERLAY:CLEAR:fade:300ms or OVERLAY:CLEAR:filename
    if (cmd.startsWith('CLEAR')) {
        const parts = cmd.slice(5).split(':').filter(p=>p);
        if (parts.length === 0) { overlayContainer.innerHTML = ''; activeOverlays = {}; return; }
        const isFade = parts.includes('FADE');
        const fadeTime = parts.find(p => /^\d+MS$/i.test(p));
        const filename = parts.find(p => !['FADE'].includes(p.toUpperCase()) && !/^\d+MS$/i.test(p));
        const targets = filename ? [filename] : Object.keys(activeOverlays);
        for (const id of targets) {
            const ov = activeOverlays[id];
            if (!ov) continue;
            if (isFade) {
                ov.element.style.transition = `opacity ${fadeTime ? parseInt(fadeTime) : 300}ms`;
                ov.element.style.opacity = '0';
                await sleep(fadeTime ? parseInt(fadeTime) : 300);
            }
            ov.element.remove();
            delete activeOverlays[id];
        }
        return;
    }
    // OVERLAY:file.png:direction:path:speed:easing:loop
    // path: -100>50|1000>-100 (position chain with optional delays)
    const parts = cmd.split(':');
    const filename = parts[0];
    const direction = (parts[1] || 'top').toLowerCase();
    const pathStr = parts[2] || '-100>50';
    const speedStr = parts[3];
    const easingStr = parts[4];
    const loopStr = parts[5];
    
    // Parse path: positions and delays
    const pathParts = pathStr.split('>').map(p => {
        if (p.includes('|')) {
            const [pos, delay] = p.split('|');
            return { pos: parseFloat(pos), delay: parseInt(delay) };
        }
        return { pos: parseFloat(p), delay: 0 };
    });
    
    // Parse speeds (can be comma-separated for each segment)
    const speeds = (speedStr || '500ms').split(',').map(s => parseSpeed(s));
    const easings = (easingStr || 'easeOut').split(',').map(e => parseEasing(e));
    const loopCount = loopStr === 'loop' ? Infinity : (parseInt(loopStr) || 1);
    
    // Create element
    const imgUrl = imageBlobs[filename];
    if (!imgUrl) { console.warn('Overlay image not found:', filename); return; }
    
    const el = document.createElement('div');
    el.className = 'overlay-item';
    el.innerHTML = `<img src="${imgUrl}">`;
    el.dataset.overlayId = filename;
    overlayContainer.appendChild(el);
    activeOverlays[filename] = { element: el };
    
    // Set initial position
    const setPosition = (percent) => {
        // 画像を中央配置してからtransformで移動
        if (direction === 'top' || direction === 'bottom') {
            el.style.left = '50%';
            el.style.transform = `translateX(-50%) translateY(${percent}%)`;
            el.style.top = '0'; el.style.bottom = 'auto';
        } else {
            el.style.top = '50%';
            el.style.transform = `translateY(-50%) translateX(${percent}%)`;
            el.style.left = '0'; el.style.right = 'auto';
        }
    };
    
    // Animation function
    const animate = async () => {
        for (let i = 0; i < pathParts.length; i++) {
            const { pos, delay } = pathParts[i];
            const speed = speeds[Math.min(i, speeds.length - 1)];
            const easing = easings[Math.min(i, easings.length - 1)];
            
            if (i === 0) {
                el.style.transition = 'none';
                setPosition(pos);
                void el.offsetWidth; // force reflow
            } else {
                el.style.transition = `all ${speed}ms ${easing}`;
                setPosition(pos);
                await sleep(speed);
            }
            if (delay > 0) await sleep(delay);
        }
    };
    
    // Run animation loop
    for (let loop = 0; loop < loopCount; loop++) {
        if (!activeOverlays[filename]) break; // stopped
        await animate();
    }
}

async function runCmd(cmd){
    const origCmd = cmd;
    cmd=cmd.toUpperCase().trim(); if(cmd.startsWith('@'))cmd=cmd.slice(1); let m;
    // 新SE構文: SE:name または SE:name:count
    m=cmd.match(/^SE:([^:]+)(?::(\d+))?$/);
    if(m){const name=origCmd.trim().split(':')[1].toLowerCase();const count=m[2]!==undefined?+m[2]:1;playSE(name,count);return null}
    // SE停止
    m=cmd.match(/^SE:STOP(?::(.+))?$/);
    if(m){if(m[1])stopSE(m[1].toLowerCase());else stopAllSE();return null}
    // 旧SE構文（後方互換）
    m=cmd.match(/^([123])SE(\d+)$/); if(m){playSE('se0'+m[1],+m[2]);return null}
    m=cmd.match(/^FLASH(\d*)$/); if(m){const n=+m[1]||1;for(let i=0;i<n;i++){doFlash();if(i<n-1)await sleep(150)}return null}
    m=cmd.match(/^SHAKE(\d*)$/); if(m){const n=+m[1]||1;for(let i=0;i<n;i++){doShake();if(i<n-1)await sleep(300)}return null}
    // 新BGM構文
    m=cmd.match(/^BGM:([^:]+)$/);
    if(m){const name=origCmd.trim().split(':')[1].toLowerCase();playBGM(name);return null}
    if(cmd==='BGM:STOP'){stopBGM();return null}
    m=cmd.match(/^SETFLAG:(.+)$/); if(m){flags[m[1]]=true;return null}
    m=cmd.match(/^IFFLAG:(.+):SKIP$/); if(m){if(flags[m[1]])return'SKIP';return null}
    m=cmd.match(/^IFFLAG:(.+):GOTO:(.+)$/); if(m){if(flags[m[1]])return{goto:m[2]};return null}
    m=cmd.match(/^NOTFLAG:(.+):GOTO:(.+)$/); if(m){if(!flags[m[1]])return{goto:m[2]};return null}
    m=cmd.match(/^FROM:(.+):SKIP$/); if(m){if(lastChoiceId===m[1])return'SKIP';return null}
    m=cmd.match(/^FROM:(.+):GOTO:(.+)$/); if(m){if(lastChoiceId===m[1])return{goto:m[2]};return null}
    // Counter commands
    m=cmd.match(/^SETCOUNTER:([^:]+):(-?\d+)$/); if(m){setCounter(m[1],parseInt(m[2]));return null}
    m=cmd.match(/^ADDCOUNTER:([^:]+):(-?\d+)$/); if(m){addCounter(m[1],parseInt(m[2]));return null}
    m=cmd.match(/^RESETCOUNTER:([^:]+)$/); if(m){resetCounter(m[1]);return null}
    m=cmd.match(/^IFCOUNTER:([^:]+):(>=|<=|==|!=|>|<):(-?\d+):GOTO:(.+)$/);
    if(m){ const val=getCounter(m[1]),cmp=parseInt(m[3]); let r=false;
        switch(m[2]){case'>=':r=val>=cmp;break;case'<=':r=val<=cmp;break;case'==':r=val==cmp;break;case'!=':r=val!=cmp;break;case'>':r=val>cmp;break;case'<':r=val<cmp;break}
        if(r)return{goto:m[4]};return null}
    m=cmd.match(/^IFCOUNTER:([^:]+):(>=|<=|==|!=|>|<):(-?\d+):SKIP$/);
    if(m){ const val=getCounter(m[1]),cmp=parseInt(m[3]); let r=false;
        switch(m[2]){case'>=':r=val>=cmp;break;case'<=':r=val<=cmp;break;case'==':r=val==cmp;break;case'!=':r=val!=cmp;break;case'>':r=val>cmp;break;case'<':r=val<cmp;break}
        if(r)return'SKIP';return null}
    // Overlay command (case-sensitive for filename)
    if(cmd.startsWith('OVERLAY:')){
        const overlayCmd = origCmd.trim().slice(8); // preserve original case for filename
        await runOverlay(overlayCmd);
        return null;
    }
    return null;
}
async function runCmdSequence(str){if(!str)return null;const lines=str.split('\n').map(l=>l.trim()).filter(l=>l);for(const line of lines){const parts=line.split(',').map(s=>s.trim()).filter(s=>s);for(let i=0;i<parts.length;i++){const group=[parts[i]];while(i+1<parts.length&&parts[i+1].startsWith('@')){group.push(parts[++i])}const results=await Promise.all(group.map(c=>runCmd(c)));for(const r of results){if(r==='SKIP')return'SKIP';if(r&&r.goto)return r}}}return null}
function openGallery(){const g=$('galleryGrid');g.innerHTML='';scenes.forEach((s,i)=>{if(!s.bgUrl)return;const seen=seenScenes.has(s.uuid);const isNew=newSceneUUIDs.has(s.uuid);const item=document.createElement('div');item.className='gallery-item'+(seen?'':' locked')+(isNew?' new':'');if(seen){item.innerHTML=`<img src="${s.bgUrl}">`;item.onclick=()=>{$('galleryModal').classList.add('hidden');isGalleryMode=true;currentIndex=i;topMenu.classList.add('hidden');gameContainer.classList.remove('hidden');showScene()}}g.appendChild(item)});$('galleryModal').classList.remove('hidden')}
function openBacklog(){const l=$('backlogList');l.innerHTML='';if(backlog.length===0){l.innerHTML='<div style="text-align:center;color:var(--text-dim);padding:24px;">No backlog</div>'}else{backlog.forEach(e=>{const item=document.createElement('div');item.className='backlog-item';item.innerHTML=`${e.name?`<div class="backlog-name">${e.name}</div>`:''}<div class="backlog-text">${e.text}</div>`;l.appendChild(item)});l.scrollTop=l.scrollHeight}$('backlogModal').classList.remove('hidden')}
function openSaveModal(){const c=$('saveSlots');c.innerHTML='';const qi=getSlotInfo(-1);const qs=document.createElement('div');qs.className='save-slot save-slot-quick'+(qi.exists?'':' empty');qs.innerHTML=`<div class="save-slot-title">Quick Save</div><div class="save-slot-info">${qi.exists?qi.date:'Empty'}</div>`;qs.onclick=()=>{quickSave();$('saveModal').classList.add('hidden')};c.appendChild(qs);const ai=getSlotInfo(0);const as=document.createElement('div');as.className='save-slot save-slot-auto'+(ai.exists?'':' empty');as.innerHTML=`<div class="save-slot-title">Auto Save</div><div class="save-slot-info">${ai.exists?ai.date:'Empty'}</div>`;c.appendChild(as);for(let i=1;i<=10;i++){const info=getSlotInfo(i);const slot=document.createElement('div');slot.className='save-slot'+(info.exists?'':' empty');slot.innerHTML=`<div class="save-slot-title">Slot ${i}</div><div class="save-slot-info">${info.exists?`${info.date}`:'Empty'}</div>`;slot.onclick=()=>{saveSlot(i);showToast('Saved');$('saveModal').classList.add('hidden')};c.appendChild(slot)}$('saveModal').classList.remove('hidden')}
function openLoadModal(){const c=$('loadSlots');c.innerHTML='';const qi=getSlotInfo(-1);if(qi.exists){const qs=document.createElement('div');qs.className='save-slot save-slot-quick';qs.innerHTML=`<div class="save-slot-title">Quick Save</div><div class="save-slot-info">${qi.date}</div>`;qs.onclick=()=>{$('loadModal').classList.add('hidden');sideMenu.classList.remove('open');quickLoad()};c.appendChild(qs)}const ai=getSlotInfo(0);if(ai.exists){const as=document.createElement('div');as.className='save-slot save-slot-auto';as.innerHTML=`<div class="save-slot-title">Auto Save</div><div class="save-slot-info">${ai.date}</div>`;as.onclick=()=>{if(loadSlot(0)){$('loadModal').classList.add('hidden');sideMenu.classList.remove('open');showScene()}};c.appendChild(as)}for(let i=1;i<=10;i++){const info=getSlotInfo(i);if(!info.exists)continue;const slot=document.createElement('div');slot.className='save-slot';slot.innerHTML=`<div class="save-slot-title">Slot ${i}</div><div class="save-slot-info">${info.date}</div>`;slot.onclick=()=>{if(loadSlot(i)){$('loadModal').classList.add('hidden');sideMenu.classList.remove('open');showScene()}};c.appendChild(slot)}if(c.children.length===0){c.innerHTML='<div style="text-align:center;color:var(--text-dim);padding:24px;">No save data</div>'}$('loadModal').classList.remove('hidden')}
$('startBtn').onclick=()=>startGame(0);$('continueBtn').onclick=continueGame;$('newScenesBtn').onclick=goToNewScenes;$('galleryBtn').onclick=openGallery;$('settingsBtn').onclick=()=>$('settingsModal').classList.remove('hidden');
$('chaptersBtn').onclick=()=>{const list=$('chaptersList');list.innerHTML='';chapters.forEach((ch,i)=>{if(ch.sceneIndex<0||ch.sceneIndex>=scenes.length)return;const scene=scenes[ch.sceneIndex];const item=document.createElement('div');item.className='chapter-item';item.innerHTML=`<div class="chapter-thumb">${scene.bgUrl?`<img src="${scene.bgUrl}">`:''}}</div><div class="chapter-info"><div class="chapter-title">${ch.comment||'Chapter '+(i+1)}</div><div class="chapter-num">Scene #${ch.sceneIndex+1}</div></div>`;item.onclick=()=>{$('chaptersModal').classList.add('hidden');startGame(ch.sceneIndex)};list.appendChild(item)});$('chaptersModal').classList.remove('hidden')};
$('ctrlToggleBtn').onclick=()=>$('ctrlMenu').classList.toggle('open');$('hamburgerBtn').onclick=()=>sideMenu.classList.toggle('open');$('closeSideMenu').onclick=()=>sideMenu.classList.remove('open');
$('sideMenuSave').onclick=()=>{sideMenu.classList.remove('open');openSaveModal()};$('sideMenuLoad').onclick=()=>{sideMenu.classList.remove('open');openLoadModal()};$('sideMenuBacklog').onclick=()=>{sideMenu.classList.remove('open');openBacklog()};$('sideMenuGallery').onclick=()=>{sideMenu.classList.remove('open');openGallery()};$('sideMenuTitle').onclick=returnToTitle;
$('hideTextBtn').onclick=toggleTextHidden;$('autoBtn').onclick=toggleAuto;$('skipBtn').onclick=toggleSkip;$('qsaveBtn').onclick=quickSave;$('qloadBtn').onclick=quickLoad;
$('closeSaveModal').onclick=()=>$('saveModal').classList.add('hidden');$('closeLoadModal').onclick=()=>$('loadModal').classList.add('hidden');$('closeGalleryModal').onclick=()=>$('galleryModal').classList.add('hidden');$('closeBacklogModal').onclick=()=>$('backlogModal').classList.add('hidden');$('closeSettingsModal').onclick=()=>$('settingsModal').classList.add('hidden');$('closeChaptersModal').onclick=()=>$('chaptersModal').classList.add('hidden');
newScenesBanner.onclick=()=>{const idx=scenes.findIndex((s,i)=>i>currentIndex&&newSceneUUIDs.has(s.uuid));if(idx>=0){currentIndex=idx;showScene()}else{newScenesBanner.classList.add('hidden')}};
gameCanvas.onclick=e=>{if(e.target.closest('.control-panel')||e.target.closest('.side-menu')||e.target.closest('.choice-btn')||e.target.closest('.choice-timer-container'))return;if(sideMenu.classList.contains('open')){sideMenu.classList.remove('open');return}if(isTextHidden){toggleTextHidden();return}nextScene()};
let lastUpTime=0;document.onkeydown=e=>{if(gameContainer.classList.contains('hidden'))return;if(e.key==='ArrowRight'||e.key===' '||e.key==='Enter'){if(isTextHidden){toggleTextHidden();return}nextScene()}if(e.key==='ArrowLeft')prevScene();if(e.key==='ArrowUp'){const now=Date.now();if(now-lastUpTime<500)returnToTitle();lastUpTime=now}if(e.key==='Escape')sideMenu.classList.toggle('open');if(e.key==='a'||e.key==='A')toggleAuto();if(e.key==='s'||e.key==='S')toggleSkip();if(e.key==='l'||e.key==='L')openBacklog();if(e.key==='h'||e.key==='H')toggleTextHidden();if(e.key==='q'||e.key==='Q')quickSave();if(e.key==='w'||e.key==='W')quickLoad()};
['saveModal','loadModal','galleryModal','backlogModal','settingsModal','chaptersModal'].forEach(id=>{$(id).onclick=e=>{if(e.target===$(id))$(id).classList.add('hidden')}});
</script>
</body>
</html>
